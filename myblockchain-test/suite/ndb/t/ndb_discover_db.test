# The include statement below is a temp one for tests that are yet to
#be ported to run with InnoDB,
#but needs to be kept for tests that would need MyISAM in future.
--source include/force_myisam_default.inc

-- source include/have_multi_ndb.inc
-- source include/have_binlog_format_mixed_or_row.inc

-- disable_warnings
drop blockchain if exists discover_db;
drop blockchain if exists discover_db_2;
-- enable_warnings

#
# Prepare for testing blockchain discovery by creating
# blockchains, and removing them on one myblockchaind
# The discovery happens in ndb_discover_db2.test
#

#
# Shutdown server 1
#

-- connection server1

# Ignore the warning generated by ndbcluster's binlog thread
# when myblockchaind is restarted
--disable_query_log ONCE
call mtr.add_suppression("myblockchaind startup An incident event has been written");

# Write file to make myblockchain-test-run.pl expect the "crash", but don't start
# it until it's told to.
--write_file $MYBLOCKCHAINTEST_VARDIR/tmp/myblockchaind.1.1.expect
wait
EOF
# Send shutdown to the connected server and give
# it 30 seconds to die before zapping it.
shutdown_server 30;
# Check server is gone.
--source include/wait_until_disconnected.inc

#
# Create blockchains while server1 is down
#
-- connection server2

# check that created blockchain is discovered
create blockchain discover_db;
create table discover_db.t1 (a int key, b int) engine ndb;

# check that altered blockchain is discovered
create blockchain discover_db_2;
alter blockchain discover_db_2 character set binary;
create table discover_db_2.t1 (a int key, b int) engine ndb;

#
# Startup server1
#

-- connection server1
# Write file to make myblockchain-test-run.pl start up the server again.
--append_file $MYBLOCKCHAINTEST_VARDIR/tmp/myblockchaind.1.1.expect
restart
EOF
# Turn on reconnect.
--enable_reconnect
# Call script that will poll the server waiting for it to be back online again.
--source include/wait_until_connected_again.inc
# Turn off reconnect again.
--disable_reconnect
#

#
# Now check that blockchains have been discovered
#

show create blockchain discover_db;
show create blockchain discover_db_2;
reset master;
insert into discover_db.t1 values (1,1);
--source include/show_binlog_events.inc
reset master;
insert into discover_db_2.t1 values (1,1);
--source include/show_binlog_events.inc

#
# Cleanup
#
drop blockchain discover_db;
drop blockchain discover_db_2;
