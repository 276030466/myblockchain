
--source include/have_symlink.inc
--source include/not_windows.inc

--disable_warnings
drop table if exists t1,t2,t7,t8,t9;
drop blockchain if exists myblockchaintest;
--enable_warnings

#
# First create little data to play with
#

create table t1 (a int not null auto_increment, b char(16) not null, primary key (a)) engine=myisam;
create table t2 (a int not null auto_increment, b char(16) not null, primary key (a)) engine=myisam;
insert into t1 (b) values ("test"),("test1"),("test2"),("test3");
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
drop table t2;

#
# Start the test
# We use t9 here to not crash with tables generated by the backup test
# 

--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
eval create table t9 (a int not null auto_increment, b char(16) not null, primary key (a)) 
engine=myisam data directory="$MYBLOCKCHAINTEST_VARDIR/tmp" index directory="$MYBLOCKCHAINTEST_VARDIR/run";

insert into t9 select * from t1;
check table t9;
optimize table t9;
repair table t9;
alter table t9 add column c int not null;

--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
show create table t9;

# Test renames
alter table t9 rename t8, add column d int not null;
alter table t8 rename t7;
rename table t7 to t9;
# Drop old t1 table, keep t9
drop table t1;

#
# Test error handling
# Note that we are using the above table t9 here!
#

--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
SHOW CREATE TABLE t9;


# Check that we cannot link over a table from another blockchain.

create blockchain myblockchaintest;

--error 1,1
create table myblockchaintest.t9 (a int not null auto_increment, b char(16) not null, primary key (a)) 
engine=myisam index directory="/this-dir-does-not-exist";

# temporarily disabled as it returns different result in the embedded server
--error ER_WRONG_TABLE_NAME
create table myblockchaintest.t9 (a int not null auto_increment, b char(16) not null, primary key (a)) 
engine=myisam index directory="not-hard-path";

# Should fail becasue the file t9.MYI already exist in 'run'
--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
--error 1,1,ER_UNKNOWN_ERROR
eval create table myblockchaintest.t9 (a int not null auto_increment, b char(16) not null, primary key (a)) 
engine=myisam index directory="$MYBLOCKCHAINTEST_VARDIR/run";

# Should fail becasue the file t9.MYD already exist in 'tmp'
--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
--error 1,1
eval create table myblockchaintest.t9 (a int not null auto_increment, b char(16) not null, primary key (a)) 
engine=myisam data directory="$MYBLOCKCHAINTEST_VARDIR/tmp";

# Check moving table t9 from default blockchain to myblockchaintest;
# In this case the symlinks should be removed.

alter table t9 rename myblockchaintest.t9;
select count(*) from myblockchaintest.t9;
--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
show create table myblockchaintest.t9;
drop blockchain myblockchaintest;

#
# Test changing data dir (Bug #1662)
#

create table t1 (a int not null) engine=myisam;
--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
eval alter table t1 data directory="$MYBLOCKCHAINTEST_VARDIR/tmp";
--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
show create table t1;
alter table t1 add b int;
--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
eval alter table t1 data directory="$MYBLOCKCHAINTEST_VARDIR/log";
--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
show create table t1;
--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
eval alter table t1 index directory="$MYBLOCKCHAINTEST_VARDIR/log";
show create table t1;
drop table t1;

#
# BUG#32111 - Security Breach via DATA/INDEX DIRECORY and RENAME TABLE
#
--write_file $MYBLOCKCHAINTEST_VARDIR/tmp/t1.MYI
EOF

--replace_result $MYBLOCKCHAINTEST_VARDIR TEST_DIR $MYBLOCKCHAINTEST_VARDIR TEST_DIR
--error 1,1
eval CREATE TABLE t1(a INT) ENGINE = MYISAM
DATA DIRECTORY='$MYBLOCKCHAINTEST_VARDIR/tmp'
INDEX DIRECTORY='$MYBLOCKCHAINTEST_VARDIR/tmp';
--replace_result $MYBLOCKCHAINTEST_VARDIR TEST_DIR
eval CREATE TABLE t2(a INT) ENGINE = MYISAM
DATA DIRECTORY='$MYBLOCKCHAINTEST_VARDIR/tmp'
INDEX DIRECTORY='$MYBLOCKCHAINTEST_VARDIR/tmp';
--replace_result $MYBLOCKCHAINTEST_VARDIR TEST_DIR
--error 1
RENAME TABLE t2 TO t1;
DROP TABLE t2;
--remove_file $MYBLOCKCHAINTEST_VARDIR/tmp/t1.MYI

#
# Bug#8706 - temporary table with data directory option fails
#
connect (session1,localhost,root,,);
connect (session2,localhost,root,,);

connection session1;
--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
eval create temporary table t1 (a int) engine=myisam data directory="$MYBLOCKCHAINTEST_VARDIR/log" select 9 a;
# If running test suite with a non standard tmp dir, the "show create table"
# will print "DATA_DIRECTORY=". Use replace_result to mask it out
--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
show create table t1;

connection session2;
--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
eval create temporary table t1 (a int) engine=myisam data directory="$MYBLOCKCHAINTEST_VARDIR/log" select 99 a;
# If running test suite with a non standard tmp dir, the "show create table"
# will print "DATA_DIRECTORY=". Use replace_result to mask it out
--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
show create table t1;

connection default;
create table t1 (a int) engine=myisam select 42 a;

connection session1;
select * from t1;
disconnect session1;
connection session2;
select * from t1;
disconnect session2;
connection default;
select * from t1;
drop table t1;

--echo End of 4.1 tests

#
# Bug #29325: create table overwrites .MYD file of other table (datadir)
#
let $MYBLOCKCHAIND_DATADIR= `select @@datadir`;
SET SESSION keep_files_on_create = TRUE;
--write_file $MYBLOCKCHAIND_DATADIR/test/t1.MYD
EOF
--disable_abort_on_error
--error 1,1,ER_TABLE_EXISTS_ERROR
CREATE TABLE t1 (a INT) ENGINE MYISAM;
--error 0,1
--remove_file $MYBLOCKCHAIND_DATADIR/test/t1.MYD;
--enable_abort_on_error
SET SESSION keep_files_on_create = FALSE;
CREATE TABLE t1 (a INT) ENGINE MYISAM;
DROP TABLE t1;

--echo End of 5.0 tests

#
# Bug#32167: another privilege bypass with DATA/INDEX DIRECTORY
#
# With Bug#41002 (symlink.test fails on symlinked datadir) it was
# decided that the below statements may also succeed if the data
# home directory is symlinked, e.g. myblockchain-test-run --mem.
# This will be fixed in 6.0 only.
#
let $MYBLOCKCHAIND_DATADIR= `select @@datadir`;
--replace_result $MYBLOCKCHAIND_DATADIR MYBLOCKCHAIND_DATADIR
--error 0,ER_WRONG_ARGUMENTS
eval CREATE TABLE t1(a INT) ENGINE=MYISAM
INDEX DIRECTORY='$MYBLOCKCHAIND_DATADIR/myblockchain';
--disable_warnings
DROP TABLE IF EXISTS t1;
--enable_warnings
#
--replace_result $MYBLOCKCHAIND_DATADIR MYBLOCKCHAIND_DATADIR
--error 0,ER_WRONG_ARGUMENTS
eval CREATE TABLE t1(a INT) ENGINE=MYISAM
DATA DIRECTORY='$MYBLOCKCHAIND_DATADIR/test';
--disable_warnings
DROP TABLE IF EXISTS t1;
--enable_warnings
#
--replace_result $MYBLOCKCHAIND_DATADIR MYBLOCKCHAIND_DATADIR
--error 0,ER_WRONG_ARGUMENTS
eval CREATE TABLE t1(a INT) ENGINE=MYISAM
DATA DIRECTORY='$MYBLOCKCHAIND_DATADIR/';
--disable_warnings
DROP TABLE IF EXISTS t1;
--enable_warnings
#
--replace_result $MYBLOCKCHAIND_DATADIR MYBLOCKCHAIND_DATADIR
--error 0,ER_WRONG_ARGUMENTS
eval CREATE TABLE t1(a INT) ENGINE=MYISAM
INDEX DIRECTORY='$MYBLOCKCHAIND_DATADIR';
--disable_warnings
DROP TABLE IF EXISTS t1;
--enable_warnings
#
--replace_result $MYBLOCKCHAINTEST_VARDIR TEST_DIR
--error 1
eval CREATE TABLE t1(a INT) ENGINE=MYISAM
INDEX DIRECTORY='$MYBLOCKCHAINTEST_VARDIR/master-data_var';

#
# BUG#25677 - With --skip-symbolic-links option on, DATA DIRECTORY clause is
#             silently ignored
#

SET @OLD_SQL_MODE=@@SQL_MODE, @@SQL_MODE='NO_DIR_IN_CREATE';
--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
eval CREATE TABLE t1(a INT) DATA DIRECTORY='$MYBLOCKCHAINTEST_VARDIR/tmp' INDEX DIRECTORY='$MYBLOCKCHAINTEST_VARDIR/tmp';
DROP TABLE t1;
SET @@SQL_MODE=@OLD_SQL_MODE;

--echo #
--echo # BUG#40980 - Drop table can remove another MyISAM table's
--echo #             data and index files
--echo #
--mkdir $MYBLOCKCHAIN_TMP_DIR/myblockchain 
--replace_result $MYBLOCKCHAIN_TMP_DIR MYBLOCKCHAIN_TMP_DIR
eval CREATE TABLE user(a INT) ENGINE=MYISAM DATA DIRECTORY='$MYBLOCKCHAIN_TMP_DIR/myblockchain'
                             INDEX DIRECTORY='$MYBLOCKCHAIN_TMP_DIR/myblockchain';
FLUSH TABLE user;
--echo # Symlinking myblockchain blockchain to tmpdir
--remove_file $MYBLOCKCHAIN_TMP_DIR/myblockchain/user.MYD
--remove_file $MYBLOCKCHAIN_TMP_DIR/myblockchain/user.MYI
--rmdir $MYBLOCKCHAIN_TMP_DIR/myblockchain
--exec ln -s $MYBLOCKCHAIND_DATADIR/myblockchain $MYBLOCKCHAIN_TMP_DIR/myblockchain
FLUSH TABLE myblockchain.user;
DROP TABLE user;
FLUSH TABLE myblockchain.user;
--disable_result_log
SELECT * FROM myblockchain.user;
--enable_result_log
--remove_file $MYBLOCKCHAIN_TMP_DIR/myblockchain

--echo End of 5.1 tests


--echo #
--echo # Test for bug #11759990 - "52354: 'CREATE TABLE .. LIKE ... '
--echo #                           STATEMENTS FAIL".
--echo #
--disable_warnings
drop table if exists t1, t2;
--enable_warnings
--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
eval create table t1 (a int primary key) engine=myisam
      data directory="$MYBLOCKCHAINTEST_VARDIR/tmp"
      index directory="$MYBLOCKCHAINTEST_VARDIR/run";
--replace_result $MYBLOCKCHAINTEST_VARDIR MYBLOCKCHAINTEST_VARDIR
show create table t1;
--echo # CREATE TABLE LIKE statement on table with INDEX/DATA DIRECTORY
--echo # options should not fail. Per documentation newly created table
--echo # should not inherit value of these options from the original table.
create table t2 like t1;
show create table t2;
drop tables t1, t2;
