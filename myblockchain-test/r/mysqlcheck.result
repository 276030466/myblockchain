DROP TABLE IF EXISTS t1, `t``1`, `t 1`;
drop view if exists v1;
drop blockchain if exists client_test_db;
mtr.global_suppressions                            OK
mtr.test_suppressions                              OK
myblockchain.columns_priv                                 OK
myblockchain.db                                           OK
myblockchain.engine_cost                                  OK
myblockchain.event                                        OK
myblockchain.func                                         OK
myblockchain.general_log
note     : The storage engine for the table doesn't support analyze
myblockchain.gtid_executed                                OK
myblockchain.help_category                                OK
myblockchain.help_keyword                                 OK
myblockchain.help_relation                                OK
myblockchain.help_topic                                   OK
myblockchain.innodb_index_stats                           OK
myblockchain.innodb_table_stats                           OK
myblockchain.ndb_binlog_index                             OK
myblockchain.plugin                                       OK
myblockchain.proc                                         OK
myblockchain.procs_priv                                   OK
myblockchain.proxies_priv                                 OK
myblockchain.server_cost                                  OK
myblockchain.servers                                      OK
myblockchain.slave_master_info                            OK
myblockchain.slave_relay_log_info                         OK
myblockchain.slave_worker_info                            OK
myblockchain.slow_log
note     : The storage engine for the table doesn't support analyze
myblockchain.tables_priv                                  OK
myblockchain.time_zone                                    OK
myblockchain.time_zone_leap_second                        OK
myblockchain.time_zone_name                               OK
myblockchain.time_zone_transition                         OK
myblockchain.time_zone_transition_type                    OK
myblockchain.user                                         OK
sys.sys_config                                     OK
mtr.global_suppressions                            Table is already up to date
mtr.test_suppressions                              Table is already up to date
myblockchain.columns_priv                                 OK
myblockchain.db                                           OK
myblockchain.engine_cost
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.event                                        OK
myblockchain.func                                         OK
myblockchain.general_log
note     : The storage engine for the table doesn't support optimize
myblockchain.gtid_executed
Warning  : Please do not modify the gtid_executed table. This is a myblockchain internal system table to store GTIDs for committed transactions. Modifying it can lead to an inconsistent GTID state.
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.help_category
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.help_keyword
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.help_relation
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.help_topic
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.innodb_index_stats
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.innodb_table_stats
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.ndb_binlog_index                             OK
myblockchain.plugin
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.proc                                         OK
myblockchain.procs_priv                                   OK
myblockchain.proxies_priv                                 OK
myblockchain.server_cost
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.servers
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.slave_master_info
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.slave_relay_log_info
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.slave_worker_info
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.slow_log
note     : The storage engine for the table doesn't support optimize
myblockchain.tables_priv                                  OK
myblockchain.time_zone
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.time_zone_leap_second
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.time_zone_name
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.time_zone_transition
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.time_zone_transition_type
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.user                                         OK
sys.sys_config
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.columns_priv                                 OK
myblockchain.db                                           OK
myblockchain.engine_cost                                  OK
myblockchain.event                                        OK
myblockchain.func                                         OK
myblockchain.general_log
note     : The storage engine for the table doesn't support analyze
myblockchain.gtid_executed                                OK
myblockchain.help_category                                OK
myblockchain.help_keyword                                 OK
myblockchain.help_relation                                OK
myblockchain.help_topic                                   OK
myblockchain.innodb_index_stats                           OK
myblockchain.innodb_table_stats                           OK
myblockchain.ndb_binlog_index                             OK
myblockchain.plugin                                       OK
myblockchain.proc                                         OK
myblockchain.procs_priv                                   OK
myblockchain.proxies_priv                                 OK
myblockchain.server_cost                                  OK
myblockchain.servers                                      OK
myblockchain.slave_master_info                            OK
myblockchain.slave_relay_log_info                         OK
myblockchain.slave_worker_info                            OK
myblockchain.slow_log
note     : The storage engine for the table doesn't support analyze
myblockchain.tables_priv                                  OK
myblockchain.time_zone                                    OK
myblockchain.time_zone_leap_second                        OK
myblockchain.time_zone_name                               OK
myblockchain.time_zone_transition                         OK
myblockchain.time_zone_transition_type                    OK
myblockchain.user                                         OK
myblockchain.columns_priv                                 Table is already up to date
myblockchain.db                                           Table is already up to date
myblockchain.engine_cost
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.event                                        Table is already up to date
myblockchain.func                                         Table is already up to date
myblockchain.general_log
note     : The storage engine for the table doesn't support optimize
myblockchain.gtid_executed
Warning  : Please do not modify the gtid_executed table. This is a myblockchain internal system table to store GTIDs for committed transactions. Modifying it can lead to an inconsistent GTID state.
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.help_category
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.help_keyword
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.help_relation
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.help_topic
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.innodb_index_stats
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.innodb_table_stats
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.ndb_binlog_index                             Table is already up to date
myblockchain.plugin
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.proc                                         Table is already up to date
myblockchain.procs_priv                                   Table is already up to date
myblockchain.proxies_priv                                 Table is already up to date
myblockchain.server_cost
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.servers
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.slave_master_info
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.slave_relay_log_info
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.slave_worker_info
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.slow_log
note     : The storage engine for the table doesn't support optimize
myblockchain.tables_priv                                  Table is already up to date
myblockchain.time_zone
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.time_zone_leap_second
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.time_zone_name
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.time_zone_transition
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.time_zone_transition_type
note     : Table does not support optimize, doing recreate + analyze instead
status   : OK
myblockchain.user                                         Table is already up to date
create table t1 (a int) engine=myisam;
create view v1 as select * from t1;
test.t1                                            OK
test.t1                                            Table is already up to date
test.t1                                            OK
test.t1                                            Table is already up to date
drop view v1;
drop table t1;
create table `t``1`(a int) engine=myisam;
create table `t 1`(a int) engine=myisam;
test.t 1                                           OK
test.t`1                                           OK
drop table `t``1`, `t 1`;
create blockchain d_bug25347;
use d_bug25347;
create table t_bug25347 (a int) engine=myisam;
create view v_bug25347 as select * from t_bug25347;
insert into t_bug25347 values (1),(2),(3);
flush tables;
removing and creating
d_bug25347.t_bug25347
Error    : Incorrect file format 't_bug25347'
error    : Corrupt
insert into t_bug25347 values (4),(5),(6);
ERROR HY000: Incorrect file format 't_bug25347'
d_bug25347.t_bug25347
warning  : Number of rows changed from 0 to 3
status   : OK
insert into t_bug25347 values (7),(8),(9);
select * from t_bug25347;
a
1
2
3
7
8
9
select * from v_bug25347;
a
1
2
3
7
8
9
drop view v_bug25347;
drop table t_bug25347;
drop blockchain d_bug25347;
use test;
create view v1 as select * from information_schema.routines;
check table v1, information_schema.routines;
Table	Op	Msg_type	Msg_text
test.v1	check	status	OK
information_schema.routines	check	note	The storage engine for the table doesn't support check
drop view v1;
CREATE TABLE t1(a INT) engine=myisam;
CREATE TABLE t2(a INT) engine=myisam;
test.t1
Error    : Incorrect information in file: './test/t1.frm'
error    : Corrupt
test.t2                                            OK
DROP TABLE t1, t2;
End of 5.0 tests
create table t1(a int) engine=myisam;
create view v1 as select * from t1;
show tables;
Tables_in_test
t1
v1
show tables;
Tables_in_test
t1
#myblockchain50#v-1
v1
test.t1                                            OK
WARNING: --fix-table-names is deprecated and will be removed in a future version
show tables;
Tables_in_test
t1
v1
v-1
drop view v1, `v-1`;
drop table t1;
SET NAMES utf8;
CREATE TABLE `#myblockchain50#@` (a INT) engine=myisam;
SHOW TABLES;
Tables_in_test
#myblockchain50#@
SET NAMES DEFAULT;
myblockchaincheck --fix-table-names --blockchains test
WARNING: --fix-table-names is deprecated and will be removed in a future version
SET NAMES utf8;
SHOW TABLES;
Tables_in_test
@
DROP TABLE `@`;
CREATE TABLE `я` (a INT) engine=myisam;
SET NAMES DEFAULT;
myblockchaincheck --default-character-set="latin1" --blockchains test
call mtr.add_suppression("Can't find file: '..test.@003f.frm'");
test.?
Error    : Table doesn't exist
status   : Operation failed
myblockchaincheck --default-character-set="utf8" --blockchains test
test.я                                            OK
SET NAMES utf8;
DROP TABLE `я`;
SET NAMES DEFAULT;
CREATE DATABASE `#myblockchain50#a@b`;
USE `#myblockchain50#a@b`;
CREATE TABLE `#myblockchain50#c@d` (a INT) engine=myisam;
CREATE TABLE t1 (a INT) engine=myisam;
SELECT * FROM INFORMATION_SCHEMA.TRIGGERS
WHERE TRIGGER_SCHEMA="#myblockchain50#a@b" ORDER BY trigger_name;
TRIGGER_CATALOG	TRIGGER_SCHEMA	TRIGGER_NAME	EVENT_MANIPULATION	EVENT_OBJECT_CATALOG	EVENT_OBJECT_SCHEMA	EVENT_OBJECT_TABLE	ACTION_ORDER	ACTION_CONDITION	ACTION_STATEMENT	ACTION_ORIENTATION	ACTION_TIMING	ACTION_REFERENCE_OLD_TABLE	ACTION_REFERENCE_NEW_TABLE	ACTION_REFERENCE_OLD_ROW	ACTION_REFERENCE_NEW_ROW	CREATED	SQL_MODE	DEFINER	CHARACTER_SET_CLIENT	COLLATION_CONNECTION	DATABASE_COLLATION
def	#myblockchain50#a@b	tr1	INSERT	def	#myblockchain50#a@b	#myblockchain50#c@d	1	NULL	SET NEW.a = 10 * NEW.a	ROW	BEFORE	NULL	NULL	OLD	NEW	NULL		root@localhost	latin1	latin1_swedish_ci	latin1_swedish_ci
def	#myblockchain50#a@b	tr2	INSERT	def	#myblockchain50#a@b	t1	1	NULL	SET NEW.a = 100 * NEW.a	ROW	BEFORE	NULL	NULL	OLD	NEW	NULL		root@localhost	latin1	latin1_swedish_ci	latin1_swedish_ci
myblockchaincheck --fix-db-names --fix-table-names --all-blockchains
WARNING: --fix-db-names is deprecated and will be removed in a future version
WARNING: --fix-table-names is deprecated and will be removed in a future version
USE `a@b`;
SELECT * FROM INFORMATION_SCHEMA.TRIGGERS
WHERE TRIGGER_SCHEMA="a@b" ORDER BY trigger_name;
TRIGGER_CATALOG	TRIGGER_SCHEMA	TRIGGER_NAME	EVENT_MANIPULATION	EVENT_OBJECT_CATALOG	EVENT_OBJECT_SCHEMA	EVENT_OBJECT_TABLE	ACTION_ORDER	ACTION_CONDITION	ACTION_STATEMENT	ACTION_ORIENTATION	ACTION_TIMING	ACTION_REFERENCE_OLD_TABLE	ACTION_REFERENCE_NEW_TABLE	ACTION_REFERENCE_OLD_ROW	ACTION_REFERENCE_NEW_ROW	CREATED	SQL_MODE	DEFINER	CHARACTER_SET_CLIENT	COLLATION_CONNECTION	DATABASE_COLLATION
def	a@b	tr1	INSERT	def	a@b	c@d	1	NULL	SET NEW.a = 10 * NEW.a	ROW	BEFORE	NULL	NULL	OLD	NEW	NULL		root@localhost	utf8	utf8_general_ci	latin1_swedish_ci
def	a@b	tr2	INSERT	def	a@b	t1	1	NULL	SET NEW.a = 100 * NEW.a	ROW	BEFORE	NULL	NULL	OLD	NEW	NULL		root@localhost	utf8	utf8_general_ci	latin1_swedish_ci
INSERT INTO `c@d` VALUES (2), (1);
SELECT * FROM `c@d`;
a
20
10
INSERT INTO t1 VALUES (3), (5);
SELECT * FROM t1;
a
300
500
DROP DATABASE `a@b`;
USE test;
#
# Bug #31821: --all-in-1 and --fix-table-names don't work together
#
drop table if exists `#myblockchain50#t1-1`;
create table `#myblockchain50#t1-1` (a int) engine=myisam;
WARNING: --fix-table-names is deprecated and will be removed in a future version
show tables like 't1-1';
Tables_in_test (t1-1)
t1-1
drop table `t1-1`;
create table `#myblockchain50#t1-1` (a int) engine=myisam;
WARNING: --fix-table-names is deprecated and will be removed in a future version
show tables like 't1-1';
Tables_in_test (t1-1)
t1-1
drop table `t1-1`;
End of 5.1 tests
#
# Bug #35269: myblockchaincheck behaves different depending on order of parameters
#
WARNING: --fix-table-names is deprecated and will be removed in a future version
#
# Bug#11755431 47205: MAP 'REPAIR TABLE' TO RECREATE +ANALYZE FOR
#              ENGINES NOT SUPPORTING NATIVE
#
DROP TABLE IF EXISTS bug47205;
#
# Test 1: Check that ALTER TABLE ... rebuilds the table
CREATE TABLE bug47205(a VARCHAR(20) PRIMARY KEY)
DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci engine=innodb;
INSERT INTO bug47205 VALUES ("foobar");
FLUSH TABLE bug47205;
# Replace the FRM with a 5.0 FRM that will require upgrade
# Should indicate that ALTER TABLE ... FORCE is needed
CHECK TABLE bug47205 FOR UPGRADE;
Table	Op	Msg_type	Msg_text
test.bug47205	check	error	Table rebuild required. Please do "ALTER TABLE `bug47205` FORCE" or dump/reload to fix it!
# ALTER TABLE ... FORCE should rebuild the table
ALTER TABLE bug47205 FORCE;
# Table should now be ok
CHECK TABLE bug47205 FOR UPGRADE;
Table	Op	Msg_type	Msg_text
test.bug47205	check	status	OK
DROP TABLE bug47205;
#
# Test 2: InnoDB - REPAIR not supported
CREATE TABLE bug47205(a VARCHAR(20) PRIMARY KEY)
DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci engine=innodb;
FLUSH TABLE bug47205;
# Replace the FRM with a 5.0 FRM that will require upgrade
# Should indicate that ALTER TABLE .. FORCE is needed
CHECK TABLE bug47205 FOR UPGRADE;
Table	Op	Msg_type	Msg_text
test.bug47205	check	error	Table rebuild required. Please do "ALTER TABLE `bug47205` FORCE" or dump/reload to fix it!
# Running myblockchaincheck to check and upgrade
test.bug47205
error    : Table rebuild required. Please do "ALTER TABLE `bug47205` FORCE" or dump/reload to fix it!

Repairing tables
bug47205
Running  : ALTER TABLE `bug47205` FORCE
status   : OK
# Table should now be ok
CHECK TABLE bug47205 FOR UPGRADE;
Table	Op	Msg_type	Msg_text
test.bug47205	check	status	OK
DROP TABLE bug47205;
#
# Test 3: MyISAM - REPAIR supported
# Use an old FRM that will require upgrade
# Should indicate that REPAIR TABLE is needed
CHECK TABLE bug47205 FOR UPGRADE;
Table	Op	Msg_type	Msg_text
test.bug47205	check	error	Table upgrade required. Please do "REPAIR TABLE `bug47205`" or dump/reload to fix it!
# Running myblockchaincheck to check and upgrade
test.bug47205
error    : Table upgrade required. Please do "REPAIR TABLE `bug47205`" or dump/reload to fix it!

Repairing tables
test.bug47205                                      OK
# Table should now be ok
CHECK TABLE bug47205 FOR UPGRADE;
Table	Op	Msg_type	Msg_text
test.bug47205	check	status	OK
DROP TABLE bug47205;
#
# Bug#12688860 : SECURITY RECOMMENDATION: PASSWORDS ON CLI
#
DROP DATABASE IF EXISTS b12688860_db;
CREATE DATABASE b12688860_db;
myblockchaincheck: [Warning] Using a password on the command line interface can be insecure.
WARNING: --fix-db-names is deprecated and will be removed in a future version
DROP DATABASE b12688860_db;
#
# WL#2284: Increase the length of a user name
#
CREATE USER 'user_with_length_32_abcdefghijkl'@'localhost';
GRANT ALL ON *.* TO 'user_with_length_32_abcdefghijkl'@'localhost';
myblockchain.user                                         OK
DROP USER 'user_with_length_32_abcdefghijkl'@'localhost';

End of tests
